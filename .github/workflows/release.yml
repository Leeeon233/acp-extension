name: Release

env:
  NPM_BASE_NAME: acp-extension-codex

on:
  push:
    tags:
      - "codex-v*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for release (optional - defaults to pushed tag or Cargo.toml version)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      tag_name: ${{ steps.get_version.outputs.tag_name }}
    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Resolve version and tag
        id: get_version
        shell: bash
        run: |
          CARGO_VERSION=$(awk -F'"' '/^version[[:space:]]*=[[:space:]]*"/ {print $2; exit}' packages/codex-acp/Cargo.toml)
          INPUT_TAG="${{ github.event.inputs.tag_name }}"

          if [ -n "$INPUT_TAG" ]; then
            TAG_NAME="$INPUT_TAG"
          elif [ -n "${GITHUB_REF_NAME:-}" ]; then
            TAG_NAME="$GITHUB_REF_NAME"
          else
            TAG_NAME="codex-v$CARGO_VERSION"
          fi

          if [[ "$TAG_NAME" == codex-v* ]]; then
            VERSION="${TAG_NAME#codex-v}"
          elif [[ "$TAG_NAME" == v* ]]; then
            VERSION="${TAG_NAME#v}"
          else
            VERSION="$CARGO_VERSION"
          fi

          if [ -z "$VERSION" ]; then
            echo "::error::Failed to resolve version"
            exit 1
          fi

          if [ -n "$CARGO_VERSION" ] && [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Tag version ($VERSION) does not match packages/codex-acp/Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

          if [[ "$TAG_NAME" != codex-v* ]]; then
            TAG_NAME="codex-v$VERSION"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

  build:
    name: Build - ${{ matrix.os }}
    needs: get-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            target: aarch64-apple-darwin
            binary_extension: ""
          - os: macos-14
            target: x86_64-apple-darwin
            binary_extension: ""
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            binary_extension: ""
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            binary_extension: ""
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            binary_extension: ""
          - os: ubuntu-22.04-arm
            target: aarch64-unknown-linux-musl
            binary_extension: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_extension: ".exe"
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            binary_extension: ".exe"

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ matrix.os }}-${{ matrix.target }}-cargo-registry-${{ hashFiles('packages/codex-acp/**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.target }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ matrix.os }}-${{ matrix.target }}-cargo-git-${{ hashFiles('packages/codex-acp/**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.os }}-${{ matrix.target }}-cargo-git-

      - if: ${{ matrix.target == 'x86_64-unknown-linux-musl' || matrix.target == 'aarch64-unknown-linux-musl'}}
        name: Install musl build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools pkg-config

      - name: Build release binary
        run: cargo build --release --manifest-path packages/codex-acp/Cargo.toml --target ${{ matrix.target }}

      - name: Create archive
        id: create_archive
        shell: bash
        run: |
          BINARY_NAME="codex-acp${{ matrix.binary_extension }}"
          ARCHIVE_BASE="codex-acp-${{ needs.get-version.outputs.version }}-${{ matrix.target }}"
          BIN_DIR="packages/codex-acp/target/${{ matrix.target }}/release"

          if [[ "${{ matrix.os }}" == windows-* ]]; then
            (cd "$BIN_DIR" && 7z a -tzip "$GITHUB_WORKSPACE/${ARCHIVE_BASE}.zip" "$BINARY_NAME")
            echo "archive_path=${ARCHIVE_BASE}.zip" >> "$GITHUB_OUTPUT"
            echo "archive_name=${ARCHIVE_BASE}.zip" >> "$GITHUB_OUTPUT"
          else
            tar -C "$BIN_DIR" -czf "${ARCHIVE_BASE}.tar.gz" "$BINARY_NAME"
            echo "archive_path=${ARCHIVE_BASE}.tar.gz" >> "$GITHUB_OUTPUT"
            echo "archive_name=${ARCHIVE_BASE}.tar.gz" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.create_archive.outputs.archive_name }}
          path: ${{ steps.create_archive.outputs.archive_path }}
          retention-days: 1

  npm-packages:
    name: Create NPM Packages
    needs: [get-version, build]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"
          registry-url: "https://registry.npmjs.org"

      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: packages/codex-acp/artifacts
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -la packages/codex-acp/artifacts/

      - name: Create platform-specific packages
        working-directory: packages/codex-acp
        env:
          NPM_BASE_NAME: ${{ env.NPM_BASE_NAME }}
        run: bash npm/publish/create-platform-packages.sh ./artifacts ./npm-packages ${{ needs.get-version.outputs.version }}

      - name: Update base package version
        working-directory: packages/codex-acp
        env:
          NPM_BASE_NAME: ${{ env.NPM_BASE_NAME }}
        run: bash npm/publish/update-base-package.sh ${{ needs.get-version.outputs.version }}

      - name: Upload NPM packages
        uses: actions/upload-artifact@v4
        with:
          name: npm-packages
          path: packages/codex-acp/npm-packages/
          retention-days: 1

      - name: Upload base package
        uses: actions/upload-artifact@v4
        with:
          name: npm-base-package
          path: packages/codex-acp/npm/
          retention-days: 1

  publish-npm-platform:
    name: Publish NPM Platform Packages
    needs: [get-version, npm-packages]
    runs-on: ubuntu-latest
    if: ${{ !github.event.repository.fork }}
    environment: release # Optional: for enhanced security
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Configure npm auth (token fallback)
        if: ${{ secrets.NPM_TOKEN != '' }}
        run: npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}

      - name: Download NPM packages
        uses: actions/download-artifact@v5
        with:
          name: npm-packages
          path: packages/codex-acp/npm-packages

      - name: Publish platform packages
        working-directory: packages/codex-acp
        run: |
          for pkg in npm-packages/*; do
            if [ -d "$pkg" ]; then
              echo "Publishing $(basename "$pkg")..."
              cd "$pkg"
              npm publish --provenance --access public
              cd ../..
            fi
          done

  publish-npm-base:
    name: Publish NPM Base Package
    needs: [get-version, npm-packages, publish-npm-platform]
    runs-on: ubuntu-latest
    if: ${{ !github.event.repository.fork }}
    environment: release # Optional: for enhanced security
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Update npm
        run: npm install -g npm@latest

      - name: Configure npm auth (token fallback)
        if: ${{ secrets.NPM_TOKEN != '' }}
        run: npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}

      - name: Download base package
        uses: actions/download-artifact@v5
        with:
          name: npm-base-package
          path: packages/codex-acp/npm

      - name: Wait for platform packages to be available
        run: |
          echo "Waiting 30 seconds for platform packages to be available on npm..."
          sleep 30

      - name: Publish base package
        working-directory: packages/codex-acp
        run: |
          cd npm
          npm publish --provenance --access public
